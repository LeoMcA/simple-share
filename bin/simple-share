#!/usr/bin/env node

var program = require('commander');
var fs = require('fs');
var WebSocket = require('ws');
var crypto = require('crypto');

var common = require('../lib/common.js');

common.setWebrtc(require('wrtc'));

var fileName;

program
  .version('0.0.0')

program
  .option('-s, --server [url:port]', 'Signalling server to use')
  .option('-c, --client [url]', 'Path to client')
  .arguments('[file]')
  .action(function(file){
    fileName = file;
    fs.stat(fileName, function(err, stats){
      if(err) common.onError(err);
      fs.readFile(fileName, function(err, data){
        if(err) common.onError(err);
        
        fileBuffer = common.setFileBuffer(data, data.length);
        
        var sid = common.setSid(createHexHash('sha-1', fileBuffer));
        
        if(program.server){
          if(program.client)
            console.log(program.client + '?s=' + program.server + '&i=' + sid);
          else
            console.log('http://' + program.server + '/client.html?s=' + program.server + '&i=' + sid);
          var ws = common.setSignalling(new WebSocket('ws://' + program.server));
        } else {
          console.log('http://simple-share.mca.me.uk/client.html?s=simple-share.mca.me.uk&i=' + sid);
          var ws = common.setSignalling(new WebSocket('ws://simple-share.mca.me.uk'));
        }
        ws.on('error', function(err){
          common.onError(err);
        });
        ws.on('open', function(){
          common.onSignallingConnect();
        });
        ws.on('message', function(data){
          common.onSignallingMessage(data, onDataChannel);
        });
      });
    });
  });

program.parse(process.argv);

if(typeof fileName === 'undefined'){
  console.error('No file specified!');
  process.exit(1);
}

function onDataChannel(dc){
  //dc.send(new Uint8Array(fileBuffer));
  console.log('dc open');
  for(var i = 0; i <= fileBuffer.length; i += 66528){
    dc.send(new Uint8Array(fileBuffer.slice(i, i + 66528)));
  }
}

function createHexHash(algo, data){
  return crypto
    .createHash('sha1')
    .update(data)
    .digest('hex')
}
